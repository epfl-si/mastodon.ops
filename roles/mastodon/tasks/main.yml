- tags: always
  include_vars: mastodon-vars.yml

- name: Create folder for Mastodon
  ansible.builtin.file:
    path: /srv/mastodon
    state: directory
  tags: 
    - mastodon
    - mastodon.setup

- name: Dockerfile for Mastodon
  ansible.builtin.template:
    src: Dockerfile-mastodon.j2
    dest: /srv/mastodon/Dockerfile
  tags: 
    - mastodon
    - mastodon.setup

- name: Internal Docker network
  community.docker.docker_network:
     name: "{{ mastodon_docker_internal_network_name }}"
  tags:
    - mastodon

- name: Mastodon database (PostgreSQL)
  include_tasks:
    file: postgresql.yml
    apply:
      tags:
        - mastodon
        - mastodon.pg
  tags:
    - mastodon
    - mastodon.pg

- name: docker-compose.yml for Mastodon's non-precious containers
  ansible.builtin.template:
    src: docker-compose-mastodon.yml.j2
    dest: /srv/mastodon/docker-compose.yml
  tags: 
    - mastodon
    - mastodon.setup

- name: .env for Mastodon
  ansible.builtin.template:
    src: mastodon.env.j2
    dest: /srv/mastodon/.env
  tags: 
    - mastodon
    - mastodon.setup

- name: Deploy Mastodon with docker-compose
  community.docker.docker_compose_v2:
    project_src: /srv/mastodon/
  register: output
  tags: 
    - mastodon
    - mastodon.run

- name: Show results
  ansible.builtin.debug:
    var: output
  tags: 
    - mastodon
    - mastodon.run
    
